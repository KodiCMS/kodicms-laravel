var CMS={models:{},views:{},collections:{},routes:{},settings:{},translations:{},plugins:{},popup_target:null,content_height:null,calculateContentHeight:function(){if(null!=this.content_height)return this.content_height;var e=$("#content-wrapper"),t=$("#main-navbar"),i=($("footer"),$(window)),a=i.outerHeight()-t.outerHeight(),n=e.outerHeight(!$("body").hasClass("iframe"))-e.innerHeight()+$("body").hasClass("iframe")?0:140;return this.content_height=a-n,this.content_height}};CMS.ui={_elements:[],add:function(e,t,i){return"function"!=typeof t?this:(CMS.ui._elements.push([e,t,i||0]),this)},call:function(e){for(var t=0;t<CMS.ui._elements.length;t++){var i=CMS.ui._elements[t];_.isArray(e)&&-1!=_.indexOf(e,i[0])?i[1]():e==i[0]&&i[1]()}},init:function(e){$("body").trigger("ui.init.before",[this]),CMS.ui._elements=_.sortBy(CMS.ui._elements,2);for(var t=0;t<CMS.ui._elements.length;t++){var i=CMS.ui._elements[t];try{e?_.isArray(e)&&-1!=_.indexOf(e,i[0])?i[1]():e==i[0]&&i[1]():i[1]()}catch(a){console.log(i[0],a)}}$("body").trigger("ui.init.after",[this])}};var Popup={_target:null,_defaults:{fixed:!0,width:"95%",height:"93%",maxWidth:"95%",maxHeight:"93%",transition:"fade",opacity:.4,speed:100,close:'<i class="fa fa-times fa-fw" />',onLoad:function(e,t){Popup._target=e}},_resizeTimer:null,defaults:function(){return this._defaults},openHTML:function(e,t,i){if(!t)var t={};if(e instanceof jQuery)var a={inline:!0,href:e};else var a={html:e};return this.get($.extend(t,a),i)},openIframe:function(e,t,i){if(!t)var t={};return this.openUrl(e,$.extend(t,{iframe:!0}),i)},openUrl:function(e,t,i){if(!t)var t={};var a=e.split("?")[0],n=$.query.load(e).set("type","iframe").toString();return e=a+n,this.get($.extend(t,{href:e}),i)},close:function(){window.top.$.colorbox.close()},get:function(e,t){$(window).resize(this.resize);var e=$.extend({},this.defaults(),e);return t?window.top.$.colorbox(e):$.colorbox(e)},resize:function(){this._resizeTimer&&clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout(function(){$.colorbox.resize({width:"95%",height:"93%",speed:100})},500)}};CMS.ui.add("popup",function(){$("body").on("click",".popup",function(e){e.preventDefault();var t=$(this).data("popup-type"),i=$(this).data("popup-params"),a=$(this).data("popup-parent");switch(t){case"html":return Popup.openHTML($(this),i,a);case"url":case"href":case"ajax":return Popup.openUrl($(this).prop("href"),i,a);default:return Popup.openIframe($(this).prop("href"),i,a)}});var e=$("form"),t=$(".iframe .form-actions").add(".form-popup"),i=e.data("api-method"),a=e.data("api-url");i&&i.length>0&&a&&a.length>0&&($(".btn-save",t).on("click",function(t){Api[i](a,e),t.preventDefault()}),$(".btn-save-close",t).on("click",function(t){Api[i](a,e,function(e){200==e.code&&Popup.close()}),t.preventDefault()})),$(".btn-close",t).on("click",function(e){Popup.close(),e.preventDefault()})});var Api={_response:null,get:function(e,t,i,a){return this.request("GET",e,t,i,a)},post:function(e,t,i,a){return this.request("POST",e,t,i,a)},put:function(e,t,i,a){return this.request("PUT",e,t,i,a)},"delete":function(e,t,i,a){return this.request("DELETE",e,t,i,a)},request:function(e,t,i,a,n){var o=this.parseUrl(t);return $.ajaxSetup({contentType:"application/json"}),i instanceof jQuery&&(i=Api.serializeObject(i)),"object"==typeof i&&"get"!=e.toLowerCase()&&(i=JSON.stringify(i)),$.ajax({type:e,url:o,data:i,dataType:"json",async:n!==!1}).done(function(t){return this._response=t,200!=t.code?Api.exception(t,a):(t.message&&CMS.messages.show(t.message,"success","fa fa-exclamation-triangle"),window.top.$("body").trigger(Api.getEventKey(e,o),[this._response]),void("function"==typeof a&&a(this._response)))}).fail(function(e){return Api.exception(e.responseJSON,a)})},parseUrl:function(e){return e},getEventKey:function(e,t){var i=e+t.replace(SITE_URL,":").replace(/\//g,":");return i.toLowerCase()},serializeObject:function(e){var t={},i={},a={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/},n=function(e,t,i){return e[t]=i,e},o=function(e){return void 0===i[e]&&(i[e]=0),i[e]++};return $.each(e.serializeArray(),function(){if(a.validate.test(this.name)){for(var e,i=this.name.match(a.key),r=this.value,s=this.name;void 0!==(e=i.pop());)s=s.replace(new RegExp("\\["+e+"\\]$"),""),e.match(a.push)?r=n([],o(s),r):e.match(a.fixed)?r=n([],e,r):e.match(a.named)&&(r=n({},e,r));t=$.extend(!0,t,r)}}),t},exception:function(e,t){switch("function"==typeof t&&t(e),e.code){case 220:break;case 110:CMS.messages.show(e.message,"error","fa fa-exclamation-triangle");for(i in e.fields)CMS.error_field(e.fields[i],"Required");break;case 120:for(i in e.errors)CMS.messages.show(e.errors[i],"error","fa fa-exclamation-triangle"),CMS.error_field(i,e.errors[i].join(", "));break;case 130:case 140:case 150:break;case 301:case 302:if("iframe"==REQUEST_TYPE){var a=e.targetUrl.indexOf("?");e.targetUrl+=-1!=a?"&type=iframe":"?type=iframe"}window.location.href=e.targetUrl;break;case 403:case 404:}},response:function(){return this._response}};CMS.ui.add("api_buttons",function(){$(".btn[data-api-url]").on("click",function(e){e.preventDefault();var t=$(this),i=function(e){},a=t.data("api-url");if(a){var i=t.data("callback");i=i?window[i]:function(e){};var n=t.data("method"),o=t.data("reload"),r=t.data("params"),s=t.data("preloader");if(o&&(i=o===!0?function(){window.location=""}:function(){window.location=o}),n||(n="GET"),s){var c="string"==typeof s?s:"body",u=CMS.loader.show(c);$(window).on(Api.getEventKey(n,Api.parseUrl(a)),function(e){CMS.loader.hide(u)})}Api.request(n,a,r,i)}})}).add("ajax_form",function(){$("body").on("submit","form.form-ajax",function(){var e=$(this),t=$("button",e).attr("disabled","disabled"),i=e.attr("action");e.data("ajax-action")&&(i=e.data("ajax-action"));var a=CMS.loader.show($(this));return Api.post(i,e,function(e){setTimeout(function(){t.removeAttr("disabled"),CMS.loader.hide(a)},1e3)}),!1})}),CMS.messages={show:function(e,t,i){}},CMS.ui.add("app",function(){var e,t=$('.page-block-placeholder[data-name="-1"]'),i=function(e){var t={};$(".page-block-placeholder").each(function(){var e=$(this),i=e.data("name");t[i]=t[i]||[],e.find(".page-widget-placeholder").each(function(){var e=$(this),a=e.data("id");t[i].push(a)})}),Api.post("/api.page.widgets.reorder",{data:t,id:pageId},$.proxy(e,this))};$(".page-block-placeholder .sortable").sortable({draggable:".page-widget-placeholder",handle:".drag-handle",group:"widgets",onEnd:i}),$(document).on("click",".page-widget-placeholder .widget-remove",function(e){e.preventDefault();var a=$(this).closest(".page-widget-placeholder");a.appendTo(t),i()}),$("body").on("click",".page-block-add-widget",function(){e=$(this).closest(".page-block-placeholder").data("name")}),$("body").on("click",".popup-widget-item",function(){var t=$(this).data("id");Api.put("/api.widget",{widget_id:t,page_id:PAGE.id,block:e},function(e){Popup.close(),window.location.reload()})})}).add("icon",function(){$("*[data-icon]").add("*[data-icon-prepend]").each(function(){var e=$(this).data("icon");$(this).hasClass("btn-labeled")&&(e+=" btn-label icon"),$(this).html('<i class="fa fa-'+e+'"></i> '+$(this).html()),$(this).removeAttr("data-icon-prepend").removeAttr("data-icon")})}),$(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),CMS.ui.init()});